<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Invite Check</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.6}
.wrap{max-width:980px;margin:0 auto;padding:28px 18px 70px}
.card{border:1px solid rgba(0,0,0,.12);border-radius:16px;padding:14px 14px;background:#fff;margin-top:14px}
input,button{font:inherit}
input{width:100%;box-sizing:border-box;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.18)}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
button{padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.18);background:#fff;cursor:pointer}
button:hover{background:rgba(0,0,0,.04)}
.k{opacity:.65}
ul{margin:8px 0 0 18px}
code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
</style>
</head>
<body>
<div class="wrap">
  <h1>Invite Check</h1>
  <p class="k">
    Local verification only. Your input is hashed in-browser (unless you paste a 64-hex token) and compared to
    <code>/agent/invite-keys.json</code>. No backend.
  </p>

  <div class="card">
    <h3>Enter Invite Key / Token</h3>
    <input id="key" placeholder="Invite key (plaintext) OR 64-hex token" />
    <div class="btns">
      <button type="button" onclick="check()">Verify</button>
      <button type="button" onclick="clearAll()">Clear</button>
    </div>
    <div id="status" class="k" style="margin-top:8px">Status: idle</div>
  </div>

  <div class="card" id="result" style="display:none">
    <h3>Granted</h3>
    <div class="k">Capabilities unlocked:</div>
    <ul id="caps"></ul>
    <div class="k" style="margin-top:10px">
      Reminder: follow <a href="https://gate.evanbei.com/principles.html">Principles</a>. Do not share keys publicly.
    </div>
  </div>

  <div class="card">
    <h3>References</h3>
    <div class="k">
      <div>Invite keys: <a href="/agent/invite-keys.json">/agent/invite-keys.json</a></div>
      <div>Manifest: <a href="/agent/manifest.json">/agent/manifest.json</a></div>
      <div>Node: <a href="/node/">/node/</a></div>
    </div>
  </div>
</div>

<script>
const INVITE_KEYS_URL = "/agent/invite-keys.json";
const MANIFEST_URL = "/agent/manifest.json";

let inviteKeys = null;
let manifest = null;

function setStatus(t){
  document.getElementById("status").textContent = "Status: " + t;
}

async function sha256(s){
  const b = new TextEncoder().encode(s);
  const h = await crypto.subtle.digest("SHA-256", b);
  return Array.from(new Uint8Array(h)).map(x=>x.toString(16).padStart(2,"0")).join("");
}

async function loadAll(){
  try{ inviteKeys = await fetch(INVITE_KEYS_URL,{cache:"no-store"}).then(r=>r.json()); }catch(e){ inviteKeys=null; }
  try{ manifest = await fetch(MANIFEST_URL,{cache:"no-store"}).then(r=>r.json()); }catch(e){ manifest=null; }
}

function capUrl(id){
  if(!manifest || !Array.isArray(manifest.capabilities)) return "";
  const hit = manifest.capabilities.find(c=>c.id===id);
  return hit ? hit.url : "";
}

function clearAll(){
  document.getElementById("key").value = "";
  document.getElementById("result").style.display = "none";
  document.getElementById("caps").innerHTML = "";
  setStatus("idle");
}

async function check(){
  const key = document.getElementById("key").value.trim();
  if(!key){ setStatus("enter a key"); return; }

  if(!inviteKeys || !manifest){
    setStatus("loading…");
    await loadAll();
  }
  if(!inviteKeys || !Array.isArray(inviteKeys.keys)){
    setStatus("failed to load invite-keys.json");
    return;
  }

  const isHex64 = /^[0-9a-fA-F]{64}$/.test(key);

  let h = "";
  if(isHex64){
    setStatus("verifying token…");
    h = key.toLowerCase();
  }else{
    setStatus("hashing…");
    h = (await sha256(key)).toLowerCase();
  }

  const hit = inviteKeys.keys.find(k => (k.sha256||"").toLowerCase() === h);
  if(!hit){
    document.getElementById("result").style.display = "none";
    document.getElementById("caps").innerHTML = "";
    setStatus("invalid key");
    return;
  }

  const caps = Array.isArray(hit.capabilities) ? hit.capabilities : [];
  const ul = document.getElementById("caps");
  ul.innerHTML = "";

  for(const c of caps){
    const li = document.createElement("li");
    const url = capUrl(c) || "";
    li.innerHTML = url ? `<strong>${c}</strong>: <a href="${url}">${url}</a>` : `<strong>${c}</strong>`;
    ul.appendChild(li);
  }

  document.getElementById("result").style.display = "block";
  setStatus("verified (" + (hit.id || "ok") + ")");
}

// preload
loadAll();
</script>
</body>
</html>
