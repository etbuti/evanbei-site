<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal — Evan Bei / billund</title>
  <meta name="description" content="Auto-discovery portal (driven by portal.json)." />
  <link rel="canonical" href="https://evanbei.com/portal/" />

  <style>
    :root{--b:rgba(0,0,0,.12);--k:rgba(0,0,0,.62);--bg:rgba(0,0,0,.04)}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.65}
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 70px}
    h1{margin:0 0 6px 0}
    .sub{color:var(--k);margin:0 0 16px 0}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{border:1px solid var(--b);border-radius:16px;padding:14px 14px;background:#fff}
    .span6{grid-column:span 6}
    .span12{grid-column:span 12}
    @media (max-width:860px){.span6{grid-column:span 12}}
    .k{color:var(--k)}
    .tag{display:inline-block;border:1px solid rgba(0,0,0,.18);border-radius:999px;padding:2px 10px;margin:0 6px 6px 0;font-size:12px;color:rgba(0,0,0,.75)}
    .list{margin:10px 0 0 0;padding:0;list-style:none}
    .list li{padding:10px 10px;border:1px solid var(--b);border-radius:12px;margin:10px 0;background:var(--bg)}
    .list a{color:inherit;text-decoration:none}
    .list a:hover{text-decoration:underline}
    .meta{font-size:12px;color:var(--k);margin-top:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .hr{height:1px;background:var(--b);margin:18px 0}
    .small{font-size:13px;color:rgba(0,0,0,.78)}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{border:1px solid var(--b);background:#fff;border-radius:12px;padding:9px 12px;cursor:pointer}
    button:hover{background:var(--bg)}
    .warn{border-color:rgba(255,0,0,.25);background:rgba(255,0,0,.04)}
  </style>

  <!-- 可选：如果你部署了 node.json，保留这个 -->
  <link rel="alternate" type="application/json" href="https://evanbei.com/.well-known/node.json" title="node.json" />
</head>

<body>
  <div class="wrap">
    <h1 id="title">Portal</h1>
    <p class="sub" id="subtitle">Human · Machine · Executable</p>

    <div class="card span12">
      <div id="tags"></div>
      <div class="small" id="intro">
        Auto-discovery mode: driven by <span class="mono">/portal/portal.json</span>.
      </div>

      <div class="btnrow" id="btns"></div>
      <div class="meta">Updated (UTC): <span id="utc" class="mono"></span></div>

      <div id="loadStatus" class="meta"></div>
    </div>

    <div class="grid" id="sections"></div>

    <div class="card span12" style="margin-top:14px">
      <h3>Public Path（外人如何被自然引导）</h3>
      <div class="small" id="pathText">
        /portal/ → (anchor/principles) → executable → machine entry
      </div>
      <div class="hr"></div>
      <div class="k small" id="pathHint">
        Key: keep paths stable, keep semantics stable.
      </div>
    </div>

    <div class="card span12" style="margin-top:14px">
      <h3>Optional（内部/私密入口）</h3>
      <div class="k small">
        不在公开 Portal 放私密链接。需要口令的页面只对“对的人”单独发链接 + 口令。
      </div>
    </div>

    <div class="meta" style="margin-top:16px">
      Canonical: <span class="mono">https://evanbei.com/portal/</span>
    </div>
  </div>

  <script>
    const DEFAULT_JSON_URL = "./portal.json";
    const utcEl = document.getElementById("utc");
    utcEl.textContent = new Date().toISOString();

    function el(tag, attrs = {}, children = []) {
      const n = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)) {
        if (k === "class") n.className = v;
        else if (k === "html") n.innerHTML = v;
        else n.setAttribute(k, v);
      }
      for (const c of children) n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
      return n;
    }

    function safeText(s){ return (s ?? "").toString(); }

    function copyText(t){
      try{ navigator.clipboard.writeText(t); alert("已复制：\n" + t); }
      catch(e){ prompt("复制失败，请手动复制：", t); }
    }

    function renderButtonRow(cfg){
      const btns = document.getElementById("btns");
      btns.innerHTML = "";
      const presets = [
        { label: "复制本页链接", value: location.href },
      ];

      if (cfg?.machine_entry) presets.push({ label: "复制 node.json", value: cfg.machine_entry });
      if (cfg?.node_page) presets.push({ label: "复制 /node/", value: cfg.node_page });

      for (const b of presets) {
        btns.appendChild(el("button", { }, [ b.label ]));
        btns.lastChild.onclick = () => copyText(b.value);
      }
    }

    function renderTop(cfg){
      document.getElementById("title").textContent = cfg?.title || "Portal";
      document.getElementById("subtitle").textContent = cfg?.subtitle || "Human · Machine · Executable";
      document.getElementById("intro").innerHTML = cfg?.intro_html
        || `Auto-discovery mode: driven by <span class="mono">/portal/portal.json</span>.`;

      const tagsEl = document.getElementById("tags");
      tagsEl.innerHTML = "";
      (cfg?.tags || ["stable","minimal","auditable","agent-ready"]).forEach(t=>{
        tagsEl.appendChild(el("span", { class:"tag" }, [t]));
      });

      document.getElementById("pathText").textContent = cfg?.public_path_text
        || "/portal/ → /web3/ or principles → talk/trade → /.well-known/node.json";
      document.getElementById("pathHint").textContent = cfg?.public_path_hint
        || "路径别变；语义别飘。内容可以少，但结构要稳定。";

      renderButtonRow(cfg);
    }

    function renderSectionCard(section){
      const card = el("div", { class: (section?.span === 12 ? "card span12" : "card span6") });
      card.appendChild(el("h3", {}, [ safeText(section?.title || "Section") ]));
      if (section?.desc) card.appendChild(el("div", { class:"k small" }, [ safeText(section.desc) ]));

      const ul = el("ul", { class:"list" });
      for (const it of (section?.items || [])) {
        const li = el("li");
        const a = el("a", { href: it.url || "#", target: "_blank", rel: "noopener" });
        a.appendChild(el("strong", {}, [ safeText(it.name || it.url || "link") ]));
        if (it.label) a.appendChild(document.createTextNode(" — " + safeText(it.label)));
        li.appendChild(a);
        if (it.meta) li.appendChild(el("div", { class:"meta" }, [ safeText(it.meta) ]));
        ul.appendChild(li);
      }
      card.appendChild(ul);

      return card;
    }

    function validateConfig(cfg){
      const errors = [];
      if (!cfg || typeof cfg !== "object") errors.push("portal.json is not a JSON object.");
      if (!Array.isArray(cfg.sections)) errors.push("Missing 'sections' array.");
      else {
        cfg.sections.forEach((s, idx)=>{
          if (!s.title) errors.push(`sections[${idx}] missing title.`);
          if (!Array.isArray(s.items)) errors.push(`sections[${idx}] missing items array.`);
        });
      }
      return errors;
    }

    async function loadPortalConfig(){
      const status = document.getElementById("loadStatus");
      status.textContent = "Loading portal.json…";
      try{
        const res = await fetch(DEFAULT_JSON_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const cfg = await res.json();

        const errs = validateConfig(cfg);
        if (errs.length){
          status.textContent = "portal.json loaded, but has validation issues.";
          status.className = "meta";
        } else {
          status.textContent = "portal.json loaded.";
        }

        renderTop(cfg);

        const sections = document.getElementById("sections");
        sections.innerHTML = "";
        (cfg.sections || []).forEach(s=>{
          sections.appendChild(renderSectionCard(s));
        });

        // If validation errors exist, show them in a warning card
        if (errs.length){
          const warn = el("div", { class:"card span12 warn" }, [
            el("h3", {}, ["Config warnings"]),
            el("div", { class:"small" }, ["以下是 portal.json 的问题（不影响页面运行，但建议修正）："]),
            el("pre", {}, [ el("code", {}, [ errs.map(e=>"• "+e).join("\n") ]) ])
          ]);
          document.getElementById("sections").prepend(warn);
        }

      }catch(e){
        status.textContent = `Failed to load portal.json (${e.message}). Using fallback content.`;
        // fallback minimal
        const fallback = {
          title: "Portal",
          subtitle: "Human · Machine · Executable",
          tags: ["stable","minimal","auditable","agent-ready"],
          machine_entry: "https://evanbei.com/.well-known/node.json",
          node_page: "https://evanbei.com/node/",
          sections: [
            {
              title: "Human-facing（给人看的）",
              desc: "宣言、原则、入口。少而稳。",
              span: 6,
              items: [
                { name:"evanbei.com /", url:"https://evanbei.com/", label:"Anchor Root", meta:"主锚点（极简）" },
                { name:"/web3/", url:"https://evanbei.com/web3/", label:"Web3 Anchor", meta:"存在声明/可封存" },
                { name:"principles", url:"https://gate.evanbei.com/principles.html", label:"Principles", meta:"绅士原则/边界" }
              ]
            },
            {
              title: "Executable（执行页）",
              desc: "网页即 Agent：做事，而非展示。",
              span: 6,
              items: [
                { name:"talk", url:"https://talk.evanbei.com/", label:"Talk", meta:"随手扔/漂流" },
                { name:"trade", url:"https://goldisle.org/trade", label:"Global Procurement", meta:"业务执行入口" }
              ]
            }
          ]
        };
        renderTop(fallback);
        const sections = document.getElementById("sections");
        sections.innerHTML = "";
        fallback.sections.forEach(s=>sections.appendChild(renderSectionCard(s)));
      }
    }

    loadPortalConfig();
  </script>
</body>
</html>
