<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Spatial Passport Generator</title>

<style>
body{ font-family:Arial; max-width:720px; margin:60px auto; }
.row{ margin:14px 0; }
input{ padding:8px; width:260px; }
.hint{ margin-left:12px; font-size:12px; opacity:.45; }
button{ padding:8px 14px; margin-right:10px; margin-top:16px; }
textarea{ width:100%; height:300px; margin-top:24px; }
</style>
</head>

<body>

<h3>Passport Generator</h3>

<div class="row">
Image name:<br>
<input id="img" value="IMG_XXXX.jpg">
<span class="hint">/spatial/images/ 内的文件名</span>
</div>

<div class="row">
Location:<br>
<input id="loc" value="London">
<span class="hint">London / Qingdao / others</span>
</div>

<div class="row">
Signature:<br>
<input id="sig" value="EB-SP-000X">
<span class="hint">自动跟随 Page ID 编号（可手动覆盖）</span>
</div>

<div class="row">
Page ID:<br>
<input id="pid" value="EB-SP-PASS-00X">
<span class="hint">建议：EB-SP-PASS-001 / 002 / 003 …</span>
</div>

<button onclick="gen()">Generate</button>
<button onclick="downloadHtml()">Download HTML</button>

<textarea id="out" placeholder="Generated HTML will appear here..."></textarea>

<script>
// ===============================
// ⭐ 自动同步编号逻辑（可锁定）
// ===============================
let sigLocked=false;
const pidInput=document.getElementById("pid");
const sigInput=document.getElementById("sig");

sigInput.addEventListener("input",()=>{ sigLocked=true; });

pidInput.addEventListener("input",()=>{
  if(sigLocked) return;
  const v=pidInput.value;
  const m=v.match(/(\d+)/);
  if(!m) return;
  const num=m[1].padStart(4,"0");
  sigInput.value="EB-SP-"+num;
});

// ===============================
// 生成 HTML 字符串
// ===============================
function buildHtml(){

  const img=document.getElementById('img').value.trim();
  const sig=document.getElementById('sig').value.trim();
  const pid=document.getElementById('pid').value.trim();
  const loc=document.getElementById('loc').value.trim();

  return `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>${pid}</title>

<!-- machine-readable tag for gallery filter -->
<meta name="x-sp-location" content="${loc}">

<style>
body{font-family:Arial;max-width:720px;margin:80px auto;}
img{width:100%;margin:30px 0;}
.small{opacity:.55;font-size:12px;}
</style>
</head>
<body>

<h3>${pid}</h3>
<p class="small">Location: ${loc}</p>

<img src="../images/${img}">

<p>SpatialSignature:<br>${sig}</p>

<p>
GroundLayer: Frozen Grid<br>
EventPlanes: Dual Dialogue<br>
Vectors: Oblique Entry<br>
AuthorityField: Vertical Macro<br>
BufferZone: Organic Divider
</p>

<p>Atmosphere: Dormant</p>

</body>
</html>`;
}

// ===============================
// 显示生成结果
// ===============================
function gen(){
  document.getElementById('out').value = buildHtml();
}

// ===============================
// PageID -> pageXX.html 文件名
// ===============================
function pageFilenameFromPid(pid){
  const m = (pid || "").match(/(\d+)/);
  if(!m) return "page00.html";
  const n = parseInt(m[1],10);
  if(!Number.isFinite(n)) return "page00.html";
  return "page" + String(n).padStart(2,"0") + ".html";
}

// ===============================
// 下载 HTML 文件（自动对齐编号）
// ===============================
function downloadHtml(){

  const pid=document.getElementById('pid').value.trim();
  const filename = pageFilenameFromPid(pid);
  const html = buildHtml();

  // 同时把输出框更新一下，方便你看
  document.getElementById('out').value = html;

  const blob = new Blob([html], {type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;   // ⭐ 自动按编号命名
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

// ===============================
// URL 自动填充（Control Panel N 用）
// ===============================
const params=new URLSearchParams(location.search);
if(params.get("pid")) pidInput.value=params.get("pid");
if(params.get("sig")) sigInput.value=params.get("sig");
</script>

</body>
</html>
