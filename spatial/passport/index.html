<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Spatial Control Panel</title>

<style>
body{
  font-family:Arial, sans-serif;
  background:#fff;
  color:#111;
  max-width:820px;
  margin:70px auto;
}

h3{
  margin-top:50px;
}

.panel a{
  display:inline-block;
  margin:6px 14px 6px 0;
  text-decoration:none;
  color:#000;
  opacity:.8;
}

.item{
  display:flex;
  align-items:center;
  margin:14px 0;
}

.item img{
  width:60px;
  height:60px;
  object-fit:cover;
  margin-right:16px;
}

.registry a{
  text-decoration:none;
  color:#000;
}

.small{
  opacity:.5;
  margin-bottom:20px;
}
</style>
</head>

<body>

<h2>Spatial Passport Â· Control Panel</h2>
<p class="small">evanbei.com internal layer</p>

<!-- ============================= -->
<!-- ðŸŸ¦ åŠŸèƒ½æ“ä½œåŒº -->
<!-- ============================= -->

<h3>Tools</h3>

<div class="panel">

<a href="generator.html">Generator</a>
<a href="charter.html">Charter</a>
<a href="silence.html">Silence</a>

</div>


<!-- ============================= -->
<!-- ðŸŸ¦ å±•ç¤ºå±‚ Registry -->
<!-- ============================= -->

<h3>Passport Registry</h3>

<div id="list" class="registry"></div>

<script>
fetch('./')
.then(r=>r.text())
.then(html=>{

  const div=document.createElement('div');
  div.innerHTML=html;

  const links=[...div.querySelectorAll('a')];

  const list=document.getElementById('list');

  const items=[];

  links.forEach(a=>{

    const href=a.getAttribute('href');

    if(!href) return;
    if(!href.endsWith('.html')) return;
    if(href.startsWith('_')) return;
    if(href==='index.html') return;
    if(href==='generator.html') return;
    if(href==='charter.html') return;
    if(href==='silence.html') return;

    fetch(href)
    .then(r=>r.text())
    .then(page=>{

      const imgMatch=page.match(/<img src="([^"]+)"/);
      if(!imgMatch) return;

      const img=imgMatch[1];

      const numMatch=href.match(/(\d+)/);
      const order=numMatch ? parseInt(numMatch[1]) : 9999;

      items.push({href,img,order});

      render();

    });

  });

  function render(){

    items.sort((a,b)=>a.order-b.order);

    list.innerHTML='';

    items.forEach(it=>{

      const wrap=document.createElement('div');
      wrap.className="item";

      const image=document.createElement('img');
      image.src=it.img;

      const link=document.createElement('a');
      link.href=it.href;
      link.textContent=it.href.replace('.html','');

      wrap.appendChild(image);
      wrap.appendChild(link);

      list.appendChild(wrap);

    });

  }

});
</script>

<script>
document.addEventListener("keydown", function(e){

  // é˜²æ­¢åœ¨è¾“å…¥æ¡†é‡Œè¯¯è§¦
  const t = document.activeElement && document.activeElement.tagName;
  if(t==="INPUT" || t==="TEXTAREA") return;

  const k = (e.key || "").toLowerCase();

  // ===== Quick Jump =====
  if(k==="g") return (window.location.href="generator.html");
  if(k==="c") return (window.location.href="charter.html");
  if(k==="s") return (window.location.href="silence.html");

  // ===== Helpers =====
  function getMaxPageNumberFromDirectoryHTML(html){
    const div=document.createElement("div");
    div.innerHTML=html;

    const links=[...div.querySelectorAll("a")];
    let max=0;

    links.forEach(a=>{
      const href=a.getAttribute("href") || "";
      // åªè®¤ pageXX.html è¿™ç§
      if(!/^page\d+\.html$/i.test(href)) return;

      const m=href.match(/(\d+)/);
      if(!m) return;

      const n=parseInt(m[1],10);
      if(Number.isFinite(n) && n>max) max=n;
    });

    return max;
  }

  // ==========================================
  // N = New Passport (Auto Number -> Generator)
  // ==========================================
  if(k==="n"){
    fetch("./")
      .then(r=>r.text())
      .then(html=>{
        const max=getMaxPageNumberFromDirectoryHTML(html);
        const next=max+1;

        const num3=String(next).padStart(3,"0");
        const pid="EB-SP-PASS-"+num3;
        const sig="EB-SP-XXXX";

        window.location.href="generator.html?pid="+encodeURIComponent(pid)+"&sig="+encodeURIComponent(sig);
      });
    return;
  }

  // ==========================================
  // I = Inspect Latest Passport (Open pageXX)
  // ==========================================
  if(k==="i"){
    fetch("./")
      .then(r=>r.text())
      .then(html=>{
        const max=getMaxPageNumberFromDirectoryHTML(html);
        if(max<=0){
          // æ²¡æœ‰ page01.html æ—¶ï¼Œç»™ä¸ªå…œåº•
          window.location.href="generator.html";
          return;
        }
        const filename="page"+String(max).padStart(2,"0")+".html";
        window.location.href=filename;
      });
    return;
  }

});
</script>
  
</body>
</html>
