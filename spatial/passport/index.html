<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Spatial Control Panel</title>

<style>
:root{
  --bg:#fff;
  --fg:#111;
  --muted:rgba(0,0,0,.5);
  --link:#000;
  --card:rgba(0,0,0,.04);
  --border:rgba(0,0,0,.08);
}
html[data-theme="dark"]{
  --bg:#0b0b0c;
  --fg:#e9e9ea;
  --muted:rgba(255,255,255,.55);
  --link:#e9e9ea;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
}
body{
  font-family:Arial, sans-serif;
  background:var(--bg);
  color:var(--fg);
  max-width:860px;
  margin:70px auto;
  padding:0 18px;
}

h3{ margin-top:46px; }

a{
  text-decoration:none;
  color:var(--link);
  opacity:.85;
}
a:hover{ opacity:1; }

.topbar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
}
.small{ opacity:.7; color:var(--muted); margin:10px 0 0; }

.btn{
  display:inline-block;
  border:1px solid var(--border);
  background:transparent;
  color:var(--fg);
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
  font-size:12px;
  opacity:.9;
}
.btn:hover{ opacity:1; }

.panel a{
  display:inline-block;
  margin:6px 14px 6px 0;
}

.kbd{
  margin-top:14px;
  padding:14px 16px;
  border:1px solid var(--border);
  border-radius:16px;
  background:var(--card);
  max-width:560px;
}
.krow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:7px 0;
  border-bottom:1px solid var(--border);
}
.krow:last-child{ border-bottom:none; }
.key{
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  border:1px solid var(--border);
  border-bottom:2px solid var(--border);
  padding:2px 8px;
  border-radius:8px;
  margin-right:10px;
  opacity:.95;
}
.kleft{ display:flex; align-items:center; }
.kdesc{ color:var(--muted); font-size:12px; }

.item{
  display:flex;
  align-items:center;
  gap:14px;
  margin:14px 0;
}
.item img{
  width:64px;
  height:64px;
  object-fit:cover;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--card);
}
.meta{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.sig{
  font-size:12px;
  color:var(--muted);
  word-break:break-all;
}
.status{
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body>

<div class="topbar">
  <div>
    <h2>Spatial Passport · Control Panel</h2>
    <p class="small">evanbei.com internal layer</p>
  </div>

  <div style="display:flex;gap:10px;align-items:center;">
    <button class="btn" id="btnTheme" type="button" title="Toggle theme (D)">Dark</button>
    <button class="btn" id="btnReload" type="button" title="Reload registry (R)">Reload</button>
  </div>
</div>

<h3>Tools</h3>
<div class="panel">
  <a href="generator.html">Generator</a>
  <a href="charter.html">Charter</a>
  <a href="silence.html">Silence</a>
</div>

<!-- 快捷键提示（你说记不住，我就直接显示） -->
<h3>Shortcuts</h3>
<div class="kbd">
  <div class="krow">
    <div class="kleft"><span class="key">N</span>New Passport</div>
    <div class="kdesc">open Generator + next number</div>
  </div>
  <div class="krow">
    <div class="kleft"><span class="key">I</span>Inspect Latest</div>
    <div class="kdesc">open newest pageXX.html</div>
  </div>
  <div class="krow">
    <div class="kleft"><span class="key">R</span>Reload</div>
    <div class="kdesc">refresh registry</div>
  </div>
  <div class="krow">
    <div class="kleft"><span class="key">G</span>Generator</div>
    <div class="kdesc">open generator.html</div>
  </div>
  <div class="krow">
    <div class="kleft"><span class="key">C</span>Charter</div>
    <div class="kdesc">open charter.html</div>
  </div>
  <div class="krow">
    <div class="kleft"><span class="key">S</span>Silence</div>
    <div class="kdesc">open silence.html</div>
  </div>
  <div class="krow">
    <div class="kleft"><span class="key">D</span>Dark Mode</div>
    <div class="kdesc">toggle theme</div>
  </div>
</div>

<h3>Passport Registry</h3>
<div id="list" class="registry"></div>
<div id="status" class="status"></div>

<script>
/* =========================
   Theme (D) + Button
========================= */
(function(){
  const saved = localStorage.getItem("spatial_theme");
  if(saved==="dark") document.documentElement.setAttribute("data-theme","dark");

  const btn=document.getElementById("btnTheme");
  function syncLabel(){
    const dark = document.documentElement.getAttribute("data-theme")==="dark";
    btn.textContent = dark ? "Light" : "Dark";
  }
  syncLabel();

  function toggleTheme(){
    const dark = document.documentElement.getAttribute("data-theme")==="dark";
    if(dark){
      document.documentElement.removeAttribute("data-theme");
      localStorage.setItem("spatial_theme","light");
    }else{
      document.documentElement.setAttribute("data-theme","dark");
      localStorage.setItem("spatial_theme","dark");
    }
    syncLabel();
  }

  btn.addEventListener("click", toggleTheme);
  window.__toggleTheme = toggleTheme;
})();
</script>

<script>
/* =========================
   Registry Loader (NO directory listing)
   Scan page01..page200 via HEAD
========================= */
const MAX_SCAN = 200;

function pad2(n){ return String(n).padStart(2,"0"); }
function pad3(n){ return String(n).padStart(3,"0"); }

async function exists(url){
  // HEAD 探测，失败再 GET 兜底（某些环境不支持 HEAD）
  try{
    const r = await fetch(url, { method:"HEAD", cache:"no-store" });
    return r.ok;
  }catch(e){
    try{
      const r2 = await fetch(url, { method:"GET", cache:"no-store" });
      return r2.ok;
    }catch(e2){
      return false;
    }
  }
}

function extractFirstImage(html){
  const m = html.match(/<img\s+[^>]*src="([^"]+)"/i);
  return m ? m[1] : null;
}

function extractSignature(html){
  // 兼容你模板里 “SpatialSignature:<br>XXX”
  const m = html.match(/SpatialSignature:\s*(?:<br>\s*)?([A-Z0-9\-_:]+)\s*/i);
  return m ? m[1] : "";
}

async function loadPageInfo(i){
  const url = "page"+pad2(i)+".html";
  const ok = await exists(url);
  if(!ok) return null;

  const html = await fetch(url, { cache:"no-store" }).then(r=>r.text());
  const img = extractFirstImage(html);
  const sig = extractSignature(html);
  return { i, url, img, sig };
}

async function loadRegistry(){
  const list=document.getElementById("list");
  const status=document.getElementById("status");
  list.innerHTML="";
  status.textContent="Scanning…";

  const found = [];

  // 批量并发，避免太慢也避免太猛（每批 10 个）
  const BATCH = 10;
  for(let start=1; start<=MAX_SCAN; start+=BATCH){
    const tasks=[];
    for(let j=start; j<start+BATCH && j<=MAX_SCAN; j++){
      tasks.push(loadPageInfo(j));
    }
    const res = await Promise.all(tasks);
    res.filter(Boolean).forEach(x=>found.push(x));
    status.textContent = `Scanning… found ${found.length}`;
  }

  found.sort((a,b)=>a.i-b.i);

  found.forEach(it=>{
    const wrap=document.createElement("div");
    wrap.className="item";

    const image=document.createElement("img");
    image.src = it.img || "";
    image.alt = it.url;

    const meta=document.createElement("div");
    meta.className="meta";

    const link=document.createElement("a");
    link.href = it.url;
    link.textContent = it.url.replace(".html","");

    const sig=document.createElement("div");
    sig.className="sig";
    sig.textContent = it.sig || "";

    meta.appendChild(link);
    if(it.sig) meta.appendChild(sig);

    wrap.appendChild(image);
    wrap.appendChild(meta);
    list.appendChild(wrap);
  });

  if(found.length===0){
    status.textContent="No pages found. Upload page01.html (or generate one), then press R.";
  }else{
    status.textContent=`Ready · ${found.length} pages`;
  }

  // 缓存给快捷键用
  window.__spatial_found = found;
}

loadRegistry();

document.getElementById("btnReload").addEventListener("click", ()=>{
  window.scrollTo({top:0,behavior:"smooth"});
  loadRegistry();
});
</script>

<script>
/* =========================
   Keyboard Control
   G/C/S/D/N/I/R
========================= */
document.addEventListener("keydown", async function(e){

  const t = document.activeElement && document.activeElement.tagName;
  if(t==="INPUT" || t==="TEXTAREA") return;

  const k = (e.key || "").toLowerCase();

  if(k==="g") return (window.location.href="generator.html");
  if(k==="c") return (window.location.href="charter.html");
  if(k==="s") return (window.location.href="silence.html");
  if(k==="d") return window.__toggleTheme && window.__toggleTheme();

  // R = Reload (no full reload, just refresh registry)
  if(k==="r"){
    window.scrollTo({top:0,behavior:"smooth"});
    loadRegistry();
    return;
  }

  // N = New Passport (next number)
  if(k==="n"){
    // 如果 registry 已经扫出来，直接用缓存；否则先扫一遍
    const found = window.__spatial_found || [];
    const max = found.length ? found[found.length-1].i : 0;
    const next = max + 1;

    const pid = "EB-SP-PASS-" + pad3(next);
    const sig = "EB-SP-XXXX";
    window.location.href = "generator.html?pid="+encodeURIComponent(pid)+"&sig="+encodeURIComponent(sig);
    return;
  }

  // I = Inspect Latest
  if(k==="i"){
    const found = window.__spatial_found || [];
    if(!found.length){
      // 没扫到就去 generator
      window.location.href="generator.html";
      return;
    }
    window.location.href = found[found.length-1].url;
    return;
  }

});

const params=new URLSearchParams(location.search);
if(params.get("pid")) document.getElementById("pid").value=params.get("pid");
if(params.get("sig")) document.getElementById("sig").value=params.get("sig");

  
</script>

</body>
</html>
