<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Spatial Gallery · Evan Bei</title>

<style>
body{
  font-family:Arial, sans-serif;
  background:#fff;
  color:#111;
  max-width:920px;
  margin:70px auto;
  padding:0 18px;
}
h2{ margin:0 0 10px; }
.small{ opacity:.6; font-size:12px; margin:0 0 24px; }

.filters{
  margin:18px 0 28px;
}
.filters button{
  margin-right:10px;
  padding:6px 12px;
  border:1px solid rgba(0,0,0,.15);
  background:#fff;
  border-radius:12px;
  cursor:pointer;
}
.filters button.active{
  background:#000;
  color:#fff;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
  gap:14px;
}

.card{
  border:1px solid rgba(0,0,0,.10);
  border-radius:16px;
  overflow:hidden;
  background:#fff;
}
.card img{
  width:100%;
  height:140px;
  object-fit:cover;
  display:block;
}
.card .cap{
  padding:10px 12px;
  font-size:12px;
  opacity:.85;
}
a{ text-decoration:none; color:#000; }
</style>
</head>

<body>

<h2>Spatial Gallery</h2>
<p class="small">Selected entries from the Spatial Passport.</p>

<div class="filters">
<button data-filter="all" class="active">All</button>
<button data-filter="london">London</button>
<button data-filter="qingdao">Qingdao</button>
<button data-filter="others">Others</button>
</div>

<div class="grid" id="grid"></div>

<script>

const MAX_SCAN = 200;
let ALL_ITEMS=[];

function pad2(n){ return String(n).padStart(2,"0"); }

async function exists(url){
  try{
    const r = await fetch(url,{method:"HEAD",cache:"no-store"});
    return r.ok;
  }catch(e){
    try{
      const r2 = await fetch(url,{method:"GET",cache:"no-store"});
      return r2.ok;
    }catch(e2){
      return false;
    }
  }
}

function extractFirstImage(html){
  const m = html.match(/<img\s+[^>]*src="([^"]+)"/i);
  return m ? m[1] : null;
}

// ⭐ 自动识别 Location / Node
function detectGroup(html){
  const m = html.match(/<meta\s+name="x-sp-location"\s+content="([^"]+)"/i);
  if(!m) return "others";
  const loc=(m[1]||"").toLowerCase();
  if(loc==="london") return "london";
  if(loc==="qingdao") return "qingdao";
  return "others";
}


async function loadPage(i){
  const url = "../passport/page"+pad2(i)+".html";
  const ok = await exists(url);
  if(!ok) return null;

  const html = await fetch(url,{cache:"no-store"}).then(r=>r.text());
  const img = extractFirstImage(html);
  const group = detectGroup(html);

  return { i, url, img, group };
}

function render(filter){

  const grid=document.getElementById("grid");
  grid.innerHTML="";

  const arr = filter==="all"
    ? ALL_ITEMS
    : ALL_ITEMS.filter(x=>x.group===filter);

  arr.forEach(it=>{

    const a=document.createElement("a");
    a.href=it.url;

    const card=document.createElement("div");
    card.className="card";

    const img=document.createElement("img");
    img.src=it.img || "";
    img.alt="page"+pad2(it.i);

    const cap=document.createElement("div");
    cap.className="cap";
    cap.textContent="page"+pad2(it.i);

    card.appendChild(img);
    card.appendChild(cap);
    a.appendChild(card);

    grid.appendChild(a);

  });
}

(async function(){

  const found=[];

  const BATCH=10;
  for(let start=1; start<=MAX_SCAN; start+=BATCH){

    const tasks=[];
    for(let j=start; j<start+BATCH && j<=MAX_SCAN; j++){
      tasks.push(loadPage(j));
    }

    const res=await Promise.all(tasks);
    res.filter(Boolean).forEach(x=>found.push(x));
  }

  found.sort((a,b)=>a.i-b.i);
  ALL_ITEMS = found;

  render("all");

})();

// ⭐ Filter 交互
document.querySelectorAll(".filters button").forEach(btn=>{
  btn.addEventListener("click",()=>{

    document.querySelectorAll(".filters button")
      .forEach(b=>b.classList.remove("active"));

    btn.classList.add("active");

    render(btn.dataset.filter);
  });
});

</script>

</body>
</html>
